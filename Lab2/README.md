# Лабораторная работа №3. Облачные сети (AWS VPC)

**Студент:** Питропов Александр, группа I2302

**Регион AWS:** `eu-central-1 (Frankfurt)`

**k:** `16` → `k%30 = 16`

---

## 1. Описание лабораторной работы

### 1.1. Постановка задачи

Ручное построение виртуальной частной сети (VPC) в AWS: создание публичной и приватной подсетей, интернет-шлюза (IGW), NAT Gateway, таблиц маршрутов и Security Groups; развёртывание трёх экземпляров EC2 — `web-server`, `db-server`, `bastion-host` — и проверка их взаимодействия.

### 1.2. Цель и основные этапы

**Цель:** научиться управлять базовыми сетевыми элементами AWS и настраивать корректную маршрутизацию между подсетями с контролем доступа.

**Основные этапы:**

1. Создание VPC и подготовка среды.
2. Настройка Internet Gateway.
3. Создание публичной и приватной подсетей.
4. Настройка таблиц маршрутов.
5. Развёртывание NAT Gateway.
6. Создание Security Groups.
7. Запуск EC2-инстансов (web, db, bastion).
8. Проверка взаимодействия.
9. Подключение к приватной подсети через bastion.
10. Завершение работы и очистка ресурсов.

---

## 2. Практическая часть (пошагово)

### Шаг 1. Подготовка среды

Вошёл в **AWS Management Console**, регион установлен `eu-central-1 (Frankfurt)` и открыт сервис **VPC**.

### Шаг 2. Создание VPC

Создана новая сеть **student-vpc-k16** с параметрами:

* IPv4 CIDR: `10.16.0.0/16`
* Tenancy: Default

**Контрольный вопрос:** маска `/16` означает, что префикс сети занимает 16 бит, а оставшиеся адреса доступны для 65 536 хостов. Маска `/8` была бы слишком широкой и не соответствует принципу изоляции подсетей.

### Шаг 3. Создание Internet Gateway

Создан IGW `student-igw-k16` и прикреплён к `student-vpc-k16`.

**Контрольный вопрос:** IGW необходим для выхода в Интернет и маршрутизации публичных IP-адресов.

### Шаг 4. Создание подсетей

#### 4.1. Публичная подсеть

* Name: `public-subnet-k16`
* CIDR: `10.16.1.0/24`
* Availability Zone: `eu-central-1a`

**Ответ:** пока подсеть не является публичной, так как маршруты к IGW ещё не настроены.

#### 4.2. Приватная подсеть

* Name: `private-subnet-k16`
* CIDR: `10.16.2.0/24`
* Availability Zone: `eu-central-1b`

**Ответ:** подсеть не является приватной, пока не настроен NAT Gateway и таблица маршрутов для неё.

### Шаг 5. Таблицы маршрутов (Route Tables)

#### 5.1. Публичная таблица маршрутов

Создана таблица **public-rt-k16** для `student-vpc-k16`. Добавлен маршрут:

* `Destination: 0.0.0.0/0`
* `Target: Internet Gateway (student-igw-k16)`

Связана с `public-subnet-k16`.

#### 5.2. Приватная таблица маршрутов

Создана **private-rt-k16** и привязана к `private-subnet-k16`. Маршрут к Интернету пока не добавлен.

**Контрольный вопрос:** привязка необходима, чтобы подсеть использовала конкретную таблицу маршрутов, иначе трафик не будет корректно направляться.

### Шаг 6. NAT Gateway

#### 6.1. Elastic IP

Создан и выделен Elastic IP для будущего NAT Gateway.

#### 6.2. Создание NAT Gateway

Создан **nat-gateway-k16** в `public-subnet-k16`, тип подключения — `Public`, с выделенным EIP.

#### 6.3. Настройка маршрута приватной RT

Добавлен маршрут:

* `Destination: 0.0.0.0/0`
* `Target: nat-gateway-k16`

**Контрольный вопрос:** NAT Gateway позволяет приватным инстансам обращаться к Интернету, подменяя их исходный IP своим публичным.

### Шаг 7. Security Groups

Созданы три группы безопасности:

#### `web-sg-k16`

* HTTP (80) — `0.0.0.0/0`
* HTTPS (443) — `0.0.0.0/0`

#### `bastion-sg-k16`

* SSH (22) — `My IP`

#### `db-sg-k16`

* MySQL (3306) — источник `web-sg-k16`
* MySQL (3306) — источник `bastion-sg-k16`
* SSH (22) — источник `bastion-sg-k16`

**Контрольный вопрос:** Bastion Host — это шлюзовой сервер, через который осуществляется безопасный доступ к ресурсам приватной подсети.

### Шаг 8. EC2-инстансы

#### `web-server`

* Subnet: `public-subnet-k16`
* Public IP: Enabled
* Security Group: `web-sg-k16`
* User data:

```bash
#!/bin/bash
dnf install -y httpd php
echo "<?php phpinfo(); ?>" > /var/www/html/index.php
systemctl enable httpd
systemctl start httpd
```

#### `db-server`

* Subnet: `private-subnet-k16`
* Public IP: Disabled
* Security Group: `db-sg-k16`
* User data:

```bash
#!/bin/bash
dnf install -y mariadb105-server
systemctl enable mariadb
systemctl start mariadb
mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED BY 'StrongPassword123!'; FLUSH PRIVILEGES;"
```

#### `bastion-host`

* Subnet: `public-subnet-k16`
* Public IP: Enabled
* Security Group: `bastion-sg-k16`
* User data:

```bash
#!/bin/bash
dnf install -y mariadb105
```

### Шаг 9. Проверка работы

* Проверен доступ к `web-server` по публичному IP (phpinfo-страница).
* Проверено подключение к Интернету с `bastion-host` (ping google.com).
* Проверено подключение с bastion к db-server через MySQL.

### Шаг 10. Подключение в приватную подсеть через Bastion Host

Для SSH Agent Forwarding:

```bash
eval "$(ssh-agent -s)"
ssh-add sasha-keypair.pem
ssh -A -J ec2-user@<Bastion-Public-IP> ec2-user@<DB-Private-IP>
```

Проверено обновление системы и установка пакетов (`dnf update`, `dnf install htop`).

**Контрольный вопрос:**

* `-A` — включает переадресацию SSH-агента (ключ хранится локально).
* `-J` — подключение через промежуточный хост (ProxyJump).

### Завершение работы

Удалены ресурсы для предотвращения затрат:

1. EC2-инстансы.
2. NAT Gateway.
3. Elastic IP.

VPC, подсети, RT и SG оставлены, так как не тарифицируются.

---

## 3. Контрольные вопросы

1. Что означает маска `/16`? — Префикс 16 бит, 65 536 адресов.
2. Почему нельзя использовать `/8`? — Слишком большой диапазон, не рекомендуется.
3. Является ли подсеть публичной сразу после создания? — Нет, пока нет маршрута к IGW.
4. Является ли подсеть приватной сразу после создания? — Нет, пока нет маршрута через NAT.
5. Зачем привязывать таблицу маршрутов к подсети? — Чтобы трафик шёл по нужному маршруту.
6. Как работает NAT Gateway? — Подменяет исходный IP приватных инстансов своим публичным.
7. Что такое Bastion Host? — Промежуточный SSH-сервер для безопасного доступа в приватную сеть.
8. Что делают опции `-A` и `-J` в SSH? — Forwarding агента и подключение через jump-host.

---

## 4. Вывод

В ходе лабораторной работы создана VPC `student-vpc-k16` с двумя подсетями, IGW, NAT Gateway, маршрутными таблицами и SG. Развёрнуты три EC2-инстанса (web, db, bastion), проверена маршрутизация и связь между подсетями. Сеть функционирует корректно, приватные ресурсы изолированы, а NAT и bastion обеспечивают безопасный доступ.

---

## 5. Использованные источники

* Методические материалы лабораторной работы AWS VPC (USM)
* Документация AWS: [Amazon VPC Basics](https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html)
* Документация AWS EC2 и NAT Gateway

